#!/usr/bin/env python3
"""
Integrated Exploit Framework
Combines vulnerability scanning with automated exploit generation
"""
import json
from datetime import datetime
from exploit_generator import ExploitGenerator
from attack_tools import AttackToolsSuite
from dom_xss_scanner import DOMXSSScanner
import os

class IntegratedExploitFramework:
    def __init__(self):
        self.exploit_gen = ExploitGenerator()
        self.attack_tools = AttackToolsSuite()
        self.dom_scanner = DOMXSSScanner()
        self.all_vulnerabilities = []
        self.generated_exploits = []
    
    def full_scan(self, target):
        """Perform comprehensive vulnerability scan"""
        print(f"\n{'='*70}")
        print("COMPREHENSIVE VULNERABILITY ASSESSMENT")
        print(f"{'='*70}\n")
        print(f"Target: {target}")
        print(f"Started: {datetime.now()}\n")
        
        # 1. XSS Scanning
        print("[1/10] DOM-based XSS Scan...")
        self.dom_scanner.scan_url(target)
        self.dom_scanner.test_dom_xss_payload(target)
        self.all_vulnerabilities.extend(self.dom_scanner.vulnerabilities)
        
        # 2. SQL Injection
        print("\n[2/10] SQL Injection Scan...")
        sql_vulns = self.attack_tools.sql_injection_scan(target)
        self.all_vulnerabilities.extend(sql_vulns)
        
        # 3. Command Injection
        print("\n[3/10] Command Injection Scan...")
        cmd_vulns = self.attack_tools.command_injection_scan(target)
        self.all_vulnerabilities.extend(cmd_vulns)
        
        # 4. XXE
        print("\n[4/10] XXE Scan...")
        xxe_vulns = self.attack_tools.xxe_scan(target)
        self.all_vulnerabilities.extend(xxe_vulns)
        
        # 5. SSRF
        print("\n[5/10] SSRF Scan...")
        ssrf_vulns = self.attack_tools.ssrf_scan(target)
        self.all_vulnerabilities.extend(ssrf_vulns)
        
        # 6. Path Traversal
        print("\n[6/10] Path Traversal Scan...")
        path_vulns = self.attack_tools.path_traversal_scan(target)
        self.all_vulnerabilities.extend(path_vulns)
        
        # 7. CORS
        print("\n[7/10] CORS Misconfiguration Check...")
        cors_vulns = self.attack_tools.cors_scan(target)
        self.all_vulnerabilities.extend(cors_vulns)
        
        # 8. Security Headers
        print("\n[8/10] Security Headers Check...")
        header_issues = self.attack_tools.security_headers_check(target)
        self.all_vulnerabilities.extend(header_issues)
        
        # 9. SSL/TLS
        print("\n[9/10] SSL/TLS Analysis...")
        ssl_issues = self.attack_tools.ssl_analysis(target)
        self.all_vulnerabilities.extend(ssl_issues)
        
        # 10. Port Scan
        print("\n[10/10] Port Scan...")
        open_ports = self.attack_tools.port_scan(target)
        
        print(f"\n{'='*70}")
        print(f"Scan completed: {datetime.now()}")
        print(f"Total vulnerabilities found: {len(self.all_vulnerabilities)}")
        print(f"{'='*70}\n")
    
    def auto_exploit_generation(self):
        """Automatically generate exploits for all vulnerabilities"""
        print("\n[*] Generating exploits for discovered vulnerabilities...")
        
        if not self.all_vulnerabilities:
            print("[!] No vulnerabilities to exploit")
            return
        
        os.makedirs('exploits', exist_ok=True)
        
        exploit_count = 0
        
        for i, vuln in enumerate(self.all_vulnerabilities, 1):
            vuln_type = vuln.get('type', '').lower()
            
            # Generate exploits based on vulnerability type
            exploits = self.exploit_gen.generate_exploit(vuln)
            
            if exploits:
                for j, exploit in enumerate(exploits, 1):
                    filename = f"exploits/{vuln_type.replace(' ', '_')}_{i}_{j}.html"
                    self.exploit_gen.save_exploit(exploit, filename)
                    
                    self.generated_exploits.append({
                        'vulnerability': vuln,
                        'exploit': exploit,
                        'filename': filename
                    })
                    
                    exploit_count += 1
        
        print(f"\n[+] Generated {exploit_count} exploits")
    
    def generate_comprehensive_report(self):
        """Generate comprehensive penetration test report"""
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        
        # JSON Report
        json_report = {
            'scan_date': datetime.now().isoformat(),
            'total_vulnerabilities': len(self.all_vulnerabilities),
            'total_exploits': len(self.generated_exploits),
            'severity_breakdown': self.get_severity_breakdown(),
            'vulnerabilities': self.all_vulnerabilities,
            'exploits': [
                {
                    'vuln_type': e['vulnerability'].get('type'),
                    'exploit_type': e['exploit'].get('type'),
                    'filename': e['filename'],
                    'severity': e['exploit'].get('severity', 'MEDIUM')
                }
                for e in self.generated_exploits
            ]
        }
        
        json_file = f'reports/pentest_report_{timestamp}.json'
        with open(json_file, 'w') as f:
            json.dump(json_report, f, indent=2)
        
        # HTML Report
        html_file = f'reports/pentest_report_{timestamp}.html'
        self.generate_html_report(html_file, json_report)
        
        # Text Report
        txt_file = f'reports/pentest_report_{timestamp}.txt'
        self.generate_text_report(txt_file, json_report)
        
        print(f"\n[+] Reports generated:")
        print(f"    JSON: {json_file}")
        print(f"    HTML: {html_file}")
        print(f"    Text: {txt_file}")
    
    def generate_html_report(self, filename, data):
        """Generate HTML penetration test report"""
        html = f"""
<!DOCTYPE html>
<html>
<head>
    <title>Penetration Test Report</title>
    <style>
        body {{
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }}
        .container {{
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }}
        h1 {{
            color: #d32f2f;
            border-bottom: 3px solid #d32f2f;
            padding-bottom: 10px;
        }}
        h2 {{
            color: #1976d2;
            margin-top: 30px;
        }}
        .summary {{
            background: #e3f2fd;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }}
        .vulnerability {{
            background: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 15px;
            margin: 10px 0;
        }}
        .critical {{ border-left-color: #d32f2f; background: #ffebee; }}
        .high {{ border-left-color: #f57c00; background: #fff3e0; }}
        .medium {{ border-left-color: #fbc02d; background: #fffde7; }}
        .low {{ border-left-color: #388e3c; background: #e8f5e9; }}
        .severity {{
            display: inline-block;
            padding: 5px 10px;
            border-radius: 3px;
            color: white;
            font-weight: bold;
        }}
        .severity.critical {{ background: #d32f2f; }}
        .severity.high {{ background: #f57c00; }}
        .severity.medium {{ background: #fbc02d; }}
        .severity.low {{ background: #388e3c; }}
        table {{
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }}
        th, td {{
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }}
        th {{
            background: #1976d2;
            color: white;
        }}
        code {{
            background: #f5f5f5;
            padding: 2px 5px;
            border-radius: 3px;
            font-family: monospace;
        }}
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”’ Penetration Test Report</h1>
        
        <div class="summary">
            <h2>Executive Summary</h2>
            <p><strong>Scan Date:</strong> {data['scan_date']}</p>
            <p><strong>Total Vulnerabilities:</strong> {data['total_vulnerabilities']}</p>
            <p><strong>Exploits Generated:</strong> {data['total_exploits']}</p>
            
            <h3>Severity Breakdown</h3>
            <table>
                <tr>
                    <th>Severity</th>
                    <th>Count</th>
                </tr>
"""
        
        for severity, count in data['severity_breakdown'].items():
            html += f"""
                <tr>
                    <td><span class="severity {severity.lower()}">{severity}</span></td>
                    <td>{count}</td>
                </tr>
"""
        
        html += """
            </table>
        </div>
        
        <h2>Detailed Findings</h2>
"""
        
        for i, vuln in enumerate(data['vulnerabilities'], 1):
            severity = vuln.get('severity', 'MEDIUM').lower()
            vuln_type = vuln.get('type', 'Unknown')
            
            html += f"""
        <div class="vulnerability {severity}">
            <h3>[{i}] {vuln_type}</h3>
            <p><span class="severity {severity}">{vuln.get('severity', 'MEDIUM')}</span></p>
"""
            
            if 'url' in vuln:
                html += f"<p><strong>URL:</strong> <code>{vuln['url']}</code></p>"
            
            if 'parameter' in vuln:
                html += f"<p><strong>Parameter:</strong> <code>{vuln['parameter']}</code></p>"
            
            if 'payload' in vuln:
                html += f"<p><strong>Payload:</strong> <code>{vuln['payload']}</code></p>"
            
            if 'source' in vuln:
                html += f"<p><strong>Source:</strong> <code>{vuln['source']}</code></p>"
            
            if 'sink' in vuln:
                html += f"<p><strong>Sink:</strong> <code>{vuln['sink']}</code></p>"
            
            html += """
        </div>
"""
        
        html += """
        <h2>Generated Exploits</h2>
        <table>
            <tr>
                <th>Vulnerability Type</th>
                <th>Exploit Type</th>
                <th>Severity</th>
                <th>File</th>
            </tr>
"""
        
        for exploit in data['exploits']:
            severity = exploit.get('severity', 'MEDIUM').lower()
            html += f"""
            <tr>
                <td>{exploit['vuln_type']}</td>
                <td>{exploit['exploit_type']}</td>
                <td><span class="severity {severity}">{exploit.get('severity', 'MEDIUM')}</span></td>
                <td><code>{exploit['filename']}</code></td>
            </tr>
"""
        
        html += """
        </table>
        
        <div style="margin-top: 50px; padding-top: 20px; border-top: 1px solid #ddd; color: #666;">
            <p><strong>Disclaimer:</strong> This report is for authorized security testing only. 
            Unauthorized use may violate computer fraud laws.</p>
        </div>
    </div>
</body>
</html>
"""
        
        with open(filename, 'w') as f:
            f.write(html)
    
    def generate_text_report(self, filename, data):
        """Generate text penetration test report"""
        with open(filename, 'w') as f:
            f.write("="*70 + "\n")
            f.write("PENETRATION TEST REPORT\n")
            f.write("="*70 + "\n\n")
            
            f.write(f"Scan Date: {data['scan_date']}\n")
            f.write(f"Total Vulnerabilities: {data['total_vulnerabilities']}\n")
            f.write(f"Exploits Generated: {data['total_exploits']}\n\n")
            
            f.write("SEVERITY BREAKDOWN\n")
            f.write("-"*70 + "\n")
            for severity, count in data['severity_breakdown'].items():
                f.write(f"{severity}: {count}\n")
            
            f.write("\n" + "="*70 + "\n")
            f.write("DETAILED FINDINGS\n")
            f.write("="*70 + "\n")
            
            for i, vuln in enumerate(data['vulnerabilities'], 1):
                f.write(f"\n[{i}] {vuln.get('type', 'Unknown')} - {vuln.get('severity', 'MEDIUM')}\n")
                f.write("-"*70 + "\n")
                
                for key, value in vuln.items():
                    if key not in ['type', 'severity']:
                        f.write(f"{key.capitalize()}: {value}\n")
                
                f.write("\n")
    
    def get_severity_breakdown(self):
        """Get vulnerability count by severity"""
        breakdown = {'CRITICAL': 0, 'HIGH': 0, 'MEDIUM': 0, 'LOW': 0}
        
        for vuln in self.all_vulnerabilities:
            severity = vuln.get('severity', 'MEDIUM')
            breakdown[severity] = breakdown.get(severity, 0) + 1
        
        return breakdown

def main():
    print("""
    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
    â•‘   Integrated Exploit Framework                           â•‘
    â•‘   Automated Vulnerability Scanning & Exploit Generation  â•‘
    â•‘   Educational & Authorized Testing Only                  â•‘
    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """)
    
    framework = IntegratedExploitFramework()
    
    target = input("\n[?] Enter target URL: ").strip()
    
    if not target:
        print("[!] No target provided")
        return
    
    # Full vulnerability scan
    framework.full_scan(target)
    
    # Auto-generate exploits
    if framework.all_vulnerabilities:
        generate = input("\n[?] Generate exploits for vulnerabilities? (y/n): ").strip().lower()
        
        if generate == 'y':
            framework.auto_exploit_generation()
        
        # Generate reports
        framework.generate_comprehensive_report()
    else:
        print("\n[+] No vulnerabilities found - target appears secure!")

if __name__ == "__main__":
    main()
